<html>
<head>
  <title>LoopBack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/jquery.slick/1.6.0/slick.css"/>

  <link rel="stylesheet" type="text/css" href="assets/css/style.css"/>
  <link rel="stylesheet" type="text/css" href="assets/css/bootstrap/login.css"/>


  <script src="//code.jquery.com/jquery-3.1.0.min.js"></script>
  <script src="//code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.slick/1.6.0/slick.min.js"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="assets/js/settings.js"></script>
  <script src="assets/js/functions.js"></script>

</head>

<body>

<ul class="topnav" id="myTopnav">
  <li><a class="active" href="#home">Home</a></li>
  <li><a href="#contact">Contact</a></li>
  <li><a href="#about">About</a></li>

  <li><a href="#" id="login-btn" data-toggle="modal" data-target="#login-modal">Login</a></li>
  <li><a href="#" id="account-btn" class="hidden" data-toggle="modal" data-target="#account-modal">Account</a></li>
  <li><a href="#" id="logout-btn" class="hidden">Logout</a></li>

  <li class="icon">
    <a href="javascript:void(0);" style="font-size:15px;" onclick="toggleTopNavigation()">â˜°</a>
  </li>
</ul>



<div class="modal fade" id="login-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="loginmodal-container">
      <h1>Login to Your Account</h1><br>
      <form>
        <input type="text" name="user" placeholder="Username">
        <input type="password" name="pass" placeholder="Password">
        <input type="submit" name="login" class="login loginmodal-submit" value="Login">
      </form>

      <div class="login-help hidden">
        <a href="#">Register</a> - <a href="#">Forgot Password</a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="account-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="loginmodal-container">
      <h1>Account Details</h1><br>

      <form>
        <h3>Email: <input type="email" name="email" placeholder="Email"></h3>
        <h3>Current Avatar: <img src="assets/images/nophoto.jpg" id="avatar"></h3>
        <input type="file" name="avatar" placeholder="Avatar">
        <input type="submit" name="account" class="login loginmodal-submit" value="Update">
      </form>

    </div>
  </div>
</div>


  <div class="my-slick-wrapper">
    <div class="my-slick-title">Shop List with Name, Logo and City</div>
    <div class="my-slick">Loading... Please, wait</div>
  </div>
</body>

<script>
  $(document).ready(function() {
    getShopList(function(result) {
      const count = result.length;
      const html = result.map(function (item) {
        return '<div class="shop-item">' +
          '<div class="logo">' +
            '<img src="' + item.image_url + '">' +
          '</div>' +
          '<div class="name">' + item.name + '</div>' +
          '<div class="city">' + item.city + '</div>' +
        '</div>';
      });

      $('.my-slick')
        .html(html)
        .slick(slickSettings);
    });


    $('#login-modal input[type="submit"]').on('click', function (event) {
      event.preventDefault();
      const login = $('#login-modal input[name="user"]').val();
      const password = $('#login-modal input[name="pass"]').val();

      $.ajax({
        url: '/api/Users/login',
        dataType: 'json',
        type: 'POST',
        data: {
          username: login,
          password: password
        },
        success: function(result) {
          userData.access_token = result.id;
          userData.user_id = result.userId;

          $.get('/api/Users/' + userData.user_id  + '?access_token=' + userData.access_token, function(fields) {
            userData.fields = fields;
            $('#login-modal').modal('hide');
            $('#logout-btn').removeClass('hidden');
            $('#account-btn').removeClass('hidden');
            $('#login-btn').addClass('hidden');
          });
        },
        error: function(result) {
          console.log(result);
        }
      })
    });

    $('#account-modal').on('shown.bs.modal', populateAccountModal);

    $('#account-modal form').on('submit', function() {
      var file_data = $('#account-modal form input[type="file"]').prop('files')[0];
      var form_data = new FormData();
      form_data.append('file', file_data);

      $.ajax({
        url         : '/api/Files/upload?user_id=' + userData.user_id ,     // point to server-side PHP script
        dataType    : 'text',           // what to expect back from the PHP script, if anything
        cache       : false,
        contentType : false,
        processData : false,
        data        : form_data,
        type        : 'post',
        success     : function(output){
          alert(output);              // display response from the PHP script, if any
        }
      });
      $('#avatar').val('');
    });

    $('#logout-btn').on('click', function (event) {
      event.preventDefault();

      $.ajax({
        url: '/api/Users/logout?access_token=' + userData.access_token,
        type: 'POST',
        success: function(result, content, response) {
          if(response.status === 204) {
            $('#logout-btn').addClass('hidden');
            $('#account-btn').addClass('hidden');
            $('#login-btn').removeClass('hidden');
          }
        },
        error: function(result) {
          console.log(result);
        }
      })
    });
  });
</script>
</html>

